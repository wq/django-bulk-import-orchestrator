import{modules as e}from"./wq.js";const{react:t}=e,{"@wq/material":n}=e;n.default;const{"prop-types":l}=e;function Center({children:e}){return t.createElement(n.ScrollView,null,t.createElement("div",{style:{flex:1,display:"flex",justifyContent:"center"}},t.createElement("div",{style:{width:"100%",maxWidth:"70em",padding:"1em",boxSizing:"border-box"}},e)))}Center.propTypes={children:l.node};const{"@wq/react":r}=e;function CloseWizard(){const{CancelButton:e,HorizontalView:n,View:l}=r.useComponents(),a=r.useReverse();return t.createElement(n,null,t.createElement(e,{to:a("run_list"),variant:"outlined",color:"secondary"},"Back"),t.createElement(l,null))}r.default;let a=class Progress{constructor(e){if(this.config={interval:.5,...e},!this.config.url)throw new Error("No URL specified!")}start(){this._throttle=0,this._throttleCount=0,this._lastProgress=null,this._timer=setInterval((()=>this.update()),1e3*this.config.interval)}stop(){this._timer&&clearInterval(this._timer),delete this._throttle,delete this._throttleCount,delete this._lastProgress,delete this._timer}async update(){if(this._pending)return;if(this._throttleCount<this._throttle)return void(this._throttleCount+=1);let e;this._throttleCount=0;try{this._pending=!0;const t=new AbortController,n=setTimeout((()=>t.abort()),1e4),l=await fetch(this.config.url,{signal:t.signal});clearTimeout(n),e=await l.json(),this._pending=!1}catch(e){return this._pending=!1,void("AbortError"===e.name?this.onError(new Error("Timeout while requesting status")):this.onError(e))}let t=!1;e.total?(this._lastProgress&&e.current<this._lastProgress||(this._lastProgress==e.current?this._throttle++:(this._lastProgress=e.current,this._throttle>0&&this._throttle--)),e.current==e.total&&(this.onComplete(e),t=!0)):(this.onIndeterminate(e),this._throttle++),"SUCCESS"!=e.status||t?"FAILURE"==e.status?this.onFail(e):t||this.onProgress(e):this.onComplete(e),e.location&&this.onNavigate(e)}onIndeterminate(e){this.config.onIndeterminate&&this.config.onIndeterminate(e)}onProgress(e){this.config.onProgress&&this.config.onProgress(e)}onError(e){this.config.onError&&this.config.onError(e)}onComplete(e){this.config.onComplete&&this.config.onComplete(e),this.stop()}onFail(e){this.stop(),this.config.onFail&&this.config.onFail(e)}onNavigate(e){this.stop(),this.config.onNavigate&&this.config.onNavigate(e)}};function useRunInfo(){const e=r.useRenderContext(),t=r.useModel("run",e.id||-1);return{...e,...t}}function useProgress(e){const[n,l]=t.useState(null),[o,i]=t.useState(null),[s,c]=t.useState(null),[u,m]=t.useState(!1),[p,d]=t.useState(null),h=r.useNav(),E=r.useConfig();return t.useEffect((()=>{const t=e=>{d(e),(e.error||e.message)&&c(e.error||e.message)},n=new a({url:e,onIndeterminate:t,onProgress(e){i(e.current/e.total*100),t(e)},onComplete(e){i(100),m(!1),t(e)},onFail(e){i(0),m(!0),t(e)},onError(e){m(!0),c(""+e)},onNavigate(e){const t=e.location.replace(E.router.base_url+"/","");h(t)}});return n.start(),l(n),()=>n.stop()}),[e]),t.useMemo((()=>({progress:n,value:o,status:s,error:u,data:p})),[n,o,s,u,p])}function ContinueForm({children:e,submitLabel:n="Continue"}){const{id:l,label:a}=useRunInfo(),{ScrollView:o,Form:i,Typography:s,SubmitButton:c,HorizontalView:u,View:m}=r.useComponents();return t.createElement(o,null,t.createElement(i,{action:`datawizard/${l}/auto`,method:"POST",backgroundSync:!1},t.createElement(s,{variant:"h5"},a),e,t.createElement(u,null,t.createElement(m,null),t.createElement(c,{icon:"continue"},n))))}function MappingFieldsetArray({label:e,subform:n,children:l}){const{Fieldset:a,Table:o,TableHead:i,TableBody:s,TableRow:c,TableTitle:u}=r.useComponents();return t.createElement(a,{label:e},t.createElement(o,null,t.createElement(i,null,t.createElement(c,null,n.filter((e=>"hidden"!==e.control.appearance)).map((e=>t.createElement(u,{key:e.name},e.label))))),t.createElement(s,null,l)))}ContinueForm.propTypes={children:l.node,submitLabel:l.string},MappingFieldsetArray.propTypes={label:l.string,subform:l.arrayOf(l.object),children:l.node},MappingFieldsetArray.Fieldset=function Fieldset({children:e}){const{TableRow:n,TableCell:l}=r.useComponents();return t.createElement(n,null,t.Children.toArray(e).filter((e=>"hidden"!==e.props.control.appearance)).map((e=>t.createElement(l,{key:e.props.name},e))))},MappingFieldsetArray.Fieldset.propTypes={children:l.node};const{"@mui/material":o}=e;function Progress({url:e}){const{value:n,error:l,status:a}=useProgress(e),{Typography:i,CloseWizard:s}=r.useComponents();return t.createElement(t.Fragment,null,t.createElement(o.LinearProgress,{style:{marginTop:16,marginBottom:16},variant:null===n?"indeterminate":"determinate",value:n}),a&&t.createElement(i,{color:l?"error":"textSecondary"},a),0===n&&l&&t.createElement(s,null))}Progress.propTypes={url:l.string};var i=Object.freeze({__proto__:null,Center:Center,CloseWizard:CloseWizard,ContinueForm:ContinueForm,MappingFieldsetArray:MappingFieldsetArray,Progress:Progress});const{formik:s}=e;function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e},c.apply(this,arguments)}function MappingSelect(e){const{name:n}=e,[,{value:l}]=s.useField(n.replace("mapping","type")),{Select:a,ReadOnly:o}=r.useInputComponents();return"unknown"===l?t.createElement(a,c({},e,{label:"",placeholder:"(No Selection)"})):t.createElement(o,e)}function ReadOnly({name:e}){const[,{value:n}]=s.useField(e),{Typography:l}=r.useComponents();return t.createElement(l,null,n)}MappingSelect.propTypes={name:l.string},ReadOnly.propTypes={name:l.string};var u=Object.freeze({__proto__:null,MappingSelect:MappingSelect,ReadOnly:ReadOnly});function SourceDetail(){const e=r.useReverse(),n=r.useRenderContext(),{page:l,item_id:a,page_config:o}=r.useRouteInfo(),{ScrollView:i,PropertyTable:s,Form:c,SubmitButton:u,Fab:m,HorizontalView:p,View:d}=r.useComponents(),h=o.form||[{name:"label"}],E=e(`${l}_edit`,a),g=o.content_type_id||`sources.${o.name}`,b=a;return t.createElement(t.Fragment,null,t.createElement(i,null,t.createElement(c,{action:"datawizard/",method:"POST",data:{content_type_id:g,object_id:b},backgroundSync:!1},t.createElement(s,{form:h,values:n}),t.createElement(p,null,t.createElement(d,null),t.createElement(u,{icon:"wizard"},"Start Data Wizard")))),!1!==o.can_change&&t.createElement(m,{icon:"edit",to:E}))}function RunAuto(){const{id:e,label:n,task_id:l,svc:a}=useRunInfo(),{Typography:o,Progress:i,Center:s}=r.useComponents(),c=`${a}/datawizard/${e}/status.json?task=${l}`;return t.createElement(s,null,t.createElement(o,{variant:"h5"},n),t.createElement(i,{url:c}))}function RunColumns(){const{id:e,label:n,result:{unknown_count:l,columns:a}}=useRunInfo(),[o,i]=t.useMemo((()=>function(e){const t=(e||[]).find((e=>e.types)),n=t?t.types:[],l=[];n.forEach((({name:e,choices:t})=>{t.forEach((({id:t,label:n})=>{l.push({name:t,label:n,group:e})}))}));const r=[{type:"repeat",name:"columns",label:"Columns",control:{appearance:"mapping-fieldset-array"},children:[{type:"string",name:"column",label:"Column",control:{appearance:"read-only"}},{type:"select one",name:"type",label:"Type",choices:[{name:"attribute",label:"EAV Column"},{name:"meta",label:"Column/Header"},{name:"instance",label:"FK Value"},{name:"unresolved",label:"Unresolved"},{name:"unknown",label:"Unknown"}],control:{appearance:"hidden"}},{type:"string",name:"name",label:"Spreadsheet Value",control:{appearance:"read-only"}},{type:"select one",name:"mapping",label:"Mapping",choices:l,control:{appearance:"mapping-select"}}]}],a={columns:e.map((({rel_id:e,column:t,type:n,name:l,mapping:r})=>({id:e,column:t,type:n,name:l,mapping:r})))};return[r,a]}(a)),[a]),{ScrollView:s,Typography:c,AutoForm:u,TableRow:m,TableCell:p,ContinueForm:d,MappingFieldsetArray:h}=r.useComponents();return l?t.createElement(s,null,t.createElement(u,{action:`datawizard/${e}/updatecolumns`,method:"POST",backgroundSync:!1,form:o,data:i},t.createElement(c,{variant:"h5"},n),t.createElement(c,{variant:"h6"},"Unknown Columns"),t.createElement(c,null,"This file contains ",l," column",l>1?"s":""," that"," ",l>1?"are":"is"," not yet recognized by this database."))):t.createElement(s,null,t.createElement(d,null,t.createElement(c,{variant:"h6"},"Mapped Columns"),t.createElement(c,null,"The following columns are mapped."),t.createElement(h,{label:o[0].label,subform:o[0].children},i.columns.map((({id:e,column:n,name:l,mapping:r})=>t.createElement(m,{key:e},t.createElement(p,null,n),t.createElement(p,null,l),t.createElement(p,null,r)))))))}function RunDetail(){const{ScrollView:e,Typography:n,Table:l,TableBody:a,TableRow:o,TableCell:i,Link:s,Center:c,ContinueForm:u}=r.useComponents(),m=useRunInfo(),{id:p,label:d,serializer_label:h,record_count:E,last_update:g}=m,b=r.useReverse();return null!==E?t.createElement(c,null,t.createElement(n,{variant:"h5"},d),t.createElement(l,null,t.createElement(a,null,t.createElement(o,null,t.createElement(i,null,"Serializer"),t.createElement(i,null,"function"==typeof h?h.call(m):h)),t.createElement(o,null,t.createElement(i,null,"Records"),t.createElement(i,null,t.createElement(s,{to:b("run_records",p)},E," record",1===E?"":"s"," imported."))),t.createElement(o,null,t.createElement(i,null,"Last Updated"),t.createElement(i,null,new Date(g).toLocaleString()))))):t.createElement(e,null,t.createElement(u,{submitLabel:"Start Import"},t.createElement(n,{variant:"h6"},"Click to start the import wizard.")))}function RunIds(){const{id:e,label:n,result:{unknown_count:l,types:a}}=useRunInfo(),[o,i]=t.useMemo((()=>function(e){const t=[],n={};return e.forEach((({type_id:e,type_label:l,ids:r})=>{const a=e.replace(".","_"),o=(r||[]).find((e=>e.choices)),i=o?o.choices.map((({id:e,label:t})=>({name:e,label:t}))):[];t.push({type:"repeat",name:a,label:`${l} Identifiers`,control:{appearance:"mapping-fieldset-array"},children:[{type:"string",name:"name",label:"Identifier",control:{appearance:"read-only"}},{type:"select one",name:"type",label:"Type",choices:[{name:"mapped",label:"Mapped"},{name:"unknown",label:"Unknown"}],control:{appearance:"hidden"}},{type:"int",name:"count",label:"Occurrences",control:{appearance:"read-only"}},{type:"select one",name:"mapping",label:l,choices:i,control:{appearance:"mapping-select"}}]}),n[a]=r.map((({ident_id:e,value:t,count:n,match:l,unknown:r})=>({id:e,name:t,type:r?"unknown":"resolved",count:n,mapping:l})))})),[t,n]}(a)),[a]),{ScrollView:s,Typography:c,AutoForm:u,TableRow:m,TableCell:p,ContinueForm:d,MappingFieldsetArray:h}=r.useComponents();return l?t.createElement(s,null,t.createElement(u,{action:`datawizard/${e}/updateids`,method:"POST",backgroundSync:!1,form:o,data:i},t.createElement(c,{variant:"h5"},n),t.createElement(c,{variant:"h6"},"Unknown Identifiers"),t.createElement(c,null,"This file contains ",l," identifier",l>1?"s":""," that"," ",l>1?"are":"is"," not yet recognized by this database."))):t.createElement(s,null,t.createElement(d,null,t.createElement(c,{variant:"h6"},"Mapped Identifiers"),t.createElement(c,null,"The following identifiers are mapped."),o.map((({name:e,label:n,children:l})=>t.createElement(h,{key:e,label:n,subform:l},i[e].map((({id:e,name:n,count:l,mapping:r})=>t.createElement(m,{key:e},t.createElement(p,null,n),t.createElement(p,null,l),t.createElement(p,null,r)))))))))}function RunList(){const{Typography:e,Link:n,Table:l,TableHead:a,TableBody:o,TableRow:i,TableTitle:s,TableCell:c,Center:u}=r.useComponents(),{list:m,empty:p}=r.useList(),d=r.useReverse();return t.createElement(u,null,t.createElement(e,{variant:"h4"},"Django Data Wizard"),t.createElement(l,null,t.createElement(a,null,t.createElement(i,null,t.createElement(s,null,"Run"),t.createElement(s,null,"Serializer"),t.createElement(s,null,"Records"),t.createElement(s,null,"Last Update"))),t.createElement(o,null,p&&t.createElement(c,{colspan:4},"No previous runs."),m.map((({id:e,label:l,serializer_label:r,record_count:a,last_update:o})=>t.createElement(i,{key:e},t.createElement(c,null,t.createElement(n,{to:d("run_detail",e)},l)),t.createElement(c,null,r||"-"),t.createElement(c,null,"number"==typeof a?a:a||"-"),t.createElement(c,null,o?new Date(o).toLocaleString():"-")))))))}function RunRecords(){const{Typography:e,Table:n,TableHead:l,TableBody:a,TableRow:o,TableTitle:i,TableCell:s,Center:c,CloseWizard:u}=r.useComponents(),m=useRunInfo(),{label:p,records:d}=m,h=d&&d.length>0;return t.createElement(c,null,t.createElement(e,{variant:"h5"},p),t.createElement(e,{variant:"h6"},"Imported Records"),t.createElement(e,null,"Import Complete!"),t.createElement(n,null,t.createElement(l,null,t.createElement(o,null,t.createElement(i,null,"Row"),t.createElement(i,null,"Record"))),t.createElement(a,null,!h&&t.createElement(s,{colspan:2},"No records imported."),h&&d.map((e=>t.createElement(o,{key:e.row},t.createElement(s,null,e.row),t.createElement(s,null,t.createElement(RecordLink,e))))))),t.createElement(u,null))}function RecordLink({success:e,object_url:n,object_label:l,fail_reason:a}){const{Link:o,Typography:i}=r.useComponents();return e?n?t.createElement(o,{to:n},l):l:t.createElement(i,{color:"error"},a||"Unknown Error")}function RunSerializers(){const{id:e,label:n,serializer:l,serializer_label:a,result:o={}}=useRunInfo(),{serializer_choices:i=[]}=o,s=t.useMemo((()=>[{type:"select one",name:"serializer",label:"Select Format",choices:i,control:{appearance:"radio"}}]),[i]),{ScrollView:c,Typography:u,AutoForm:m,ContinueForm:p,Center:d}=r.useComponents();return l?t.createElement(c,null,t.createElement(p,null,t.createElement(u,{variant:"h6"},"Data Format"),t.createElement(u,null,"This dataset will be parsed as “",a,"”."))):i.length>0?t.createElement(c,null,t.createElement(m,{action:`datawizard/${e}/updateserializer`,method:"POST",backgroundSync:!1,form:s},t.createElement(u,{variant:"h5"},n),t.createElement(u,{variant:"h6"},"Select a format to continue"))):t.createElement(d,null,t.createElement(u,{variant:"h6",color:"error"},"No serializers registered."),t.createElement(u,null,"See"," ",t.createElement("a",{href:"https://django-data-wizard.wq.io/overview/setup#target-model-registration"},"https://django-data-wizard.wq.io/overview/setup#target-model-registration")," ","for more information."))}RecordLink.propTypes={success:l.bool,object_url:l.string,object_label:l.string,fail_reason:l.string};var m=Object.freeze({__proto__:null,FilesourceDetail:SourceDetail,RunAuto:RunAuto,RunColumns:RunColumns,RunData:RunAuto,RunDetail:RunDetail,RunIds:RunIds,RunList:RunList,RunRecords:RunRecords,RunSerializers:RunSerializers,SourceDetail:SourceDetail,UrlsourceDetail:SourceDetail});const{"@mui/material/utils":p}=e,{"react/jsx-runtime":d}=e;var h=p.createSvgIcon(d.jsx("path",{d:"M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"}),"Replay"),E=p.createSvgIcon(d.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),g=p.createSvgIcon(d.jsx("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"}),"AutoAwesome");const b={name:"wizard",components:{...i},inputs:{...u},views:{...m},icons:{...Object.freeze({__proto__:null,Back:h,Continue:E,Wizard:g})},async context(e,t){const{page:n,mode:l,full_path:r}=t;if("run"===n&&l&&!["list","detail","edit","auto","data"].includes(l)){const e=await fetch(r,{headers:{Accept:"application/json"}}),t=await e.json();return"records"!==l&&await this.app.models.run.update([t]),t}}};export{Center,CloseWizard,ContinueForm,SourceDetail as FilesourceDetail,MappingFieldsetArray,Progress,RunAuto,RunColumns,RunAuto as RunData,RunDetail,RunIds,RunList,RunRecords,RunSerializers,SourceDetail,SourceDetail as UrlsourceDetail,b as default,useProgress,useRunInfo};
//# sourceMappingURL=wizard.js.map
