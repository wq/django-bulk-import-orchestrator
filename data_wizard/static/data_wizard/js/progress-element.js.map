{"version":3,"file":"progress-element.js","sources":["django-data-wizard/packages/progress/src/progress.js","django-data-wizard/packages/progress-element/src/progress.js"],"sourcesContent":["export class Progress {\n    constructor(config) {\n        this.config = {\n            interval: 0.5,\n            ...config,\n        };\n        if (!this.config.url) {\n            throw new Error('No URL specified!');\n        }\n    }\n    start() {\n        this._throttle = 0;\n        this._throttleCount = 0;\n        this._lastProgress = null;\n        this._timer = setInterval(\n            () => this.update(),\n            this.config.interval * 1000\n        );\n    }\n    stop() {\n        if (this._timer) {\n            clearInterval(this._timer);\n        }\n        delete this._throttle;\n        delete this._throttleCount;\n        delete this._lastProgress;\n        delete this._timer;\n    }\n    async update() {\n        if (this._pending) {\n            return;\n        }\n        if (this._throttleCount < this._throttle) {\n            this._throttleCount += 1;\n            return;\n        } else {\n            this._throttleCount = 0;\n        }\n        let data;\n        try {\n            this._pending = true;\n            const controller = new AbortController(),\n                timeout = setTimeout(() => controller.abort(), 10000),\n                response = await fetch(this.config.url, {\n                    signal: controller.signal,\n                });\n\n            clearTimeout(timeout);\n            data = await response.json();\n            this._pending = false;\n        } catch (e) {\n            this._pending = false;\n            if (e.name === 'AbortError') {\n                this.onError(new Error('Timeout while requesting status'));\n            } else {\n                this.onError(e);\n            }\n            return;\n        }\n\n        let done = false;\n        if (!data.total) {\n            this.onIndeterminate(data);\n            this._throttle++;\n        } else {\n            // Set to progress level\n            if (this._lastProgress && data.current < this._lastProgress) {\n                // Assume out-of order response; no update\n                /* jshint noempty: false */\n            } else if (this._lastProgress == data.current) {\n                // No change since last check; check less often\n                this._throttle++;\n            } else {\n                // Change since last check; check more often\n                this._lastProgress = data.current;\n                if (this._throttle > 0) {\n                    this._throttle--;\n                }\n            }\n\n            if (data.current == data.total) {\n                this.onComplete(data);\n                done = true;\n            }\n        }\n\n        if (data.status == 'SUCCESS' && !done) {\n            this.onComplete(data);\n        } else if (data.status == 'FAILURE') {\n            this.onFail(data);\n        } else if (!done) {\n            this.onProgress(data);\n        }\n\n        if (data.location) {\n            this.onNavigate(data);\n        }\n    }\n\n    onIndeterminate(data) {\n        if (this.config.onIndeterminate) {\n            this.config.onIndeterminate(data);\n        }\n    }\n\n    onProgress(data) {\n        if (this.config.onProgress) {\n            this.config.onProgress(data);\n        }\n    }\n\n    onError(error) {\n        if (this.config.onError) {\n            this.config.onError(error);\n        }\n    }\n\n    onComplete(data) {\n        if (this.config.onComplete) {\n            this.config.onComplete(data);\n        }\n        this.stop();\n    }\n\n    onFail(data) {\n        this.stop();\n        if (this.config.onFail) {\n            this.config.onFail(data);\n        }\n    }\n\n    onNavigate(data) {\n        this.stop();\n        if (this.config.onNavigate) {\n            this.config.onNavigate(data);\n        }\n    }\n}\n","import $ from 'jquery';\nimport { Progress } from '@wq/progress';\n\n// Active progress instances\nvar _timers = {};\n\nexport function run($page) {\n    var $progress = $page.find('progress'),\n        $status;\n    if (!$progress.length) {\n        return;\n    }\n\n    if ($progress.data('wq-status')) {\n        $status = $page.find('#' + $progress.data('wq-status'));\n    }\n    // Look for a data-wq-url attribute to poll (and an optional data-interval attribute)\n    const url = $progress.data('wq-url'),\n        interval = $progress.data('wq-interval') || 0.5;\n\n    if (!url || _timers[url]) {\n        return;\n    }\n    function updateStatus(data) {\n        if ((data.error || data.message) && $status) {\n            $status.text(data.error || data.message);\n        }\n    }\n    _timers[url] = new Progress({\n        url,\n        interval,\n        onIndeterminate(data) {\n            // Set to \"intermediate\" state\n            $progress.attr('value', null);\n            $progress.attr('max', null);\n\n            // Fallback for old browsers\n            $progress.html('Loading...');\n            updateStatus(data);\n        },\n        onProgress(data) {\n            $progress.attr('value', data.current);\n            $progress.attr('max', data.total);\n\n            // Fallback for old browsers\n            $progress.html((data.current / data.total) * 100 + '%');\n            updateStatus(data);\n        },\n        onComplete(data) {\n            $progress.attr('value', data.total || 0);\n            $progress.attr('max', data.total || 0);\n            if ($status) {\n                $status.removeClass('error');\n            }\n            updateStatus(data);\n        },\n        onFail(data) {\n            $progress.attr('value', 0);\n            $progress.attr('max', data.total || 0);\n            if ($status) {\n                $status.addClass('error');\n            }\n            updateStatus(data);\n            $('.submit-row').show();\n        },\n        onError(err) {\n            if ($status) {\n                $status.text(err).addClass('error');\n            } else {\n                console.error(err);\n            }\n        },\n        onNavigate(data) {\n            window.location.href = data.location;\n        },\n    });\n    _timers[url].start();\n}\n\n$(document).ready(function () {\n    run($('body'));\n});\n"],"names":["Progress","constructor","config","interval","url","Error","start","_throttle","_throttleCount","_lastProgress","_timer","setInterval","update","stop","clearInterval","_pending","data","controller","AbortController","timeout","setTimeout","abort","response","fetch","signal","clearTimeout","json","e","name","onError","done","total","onIndeterminate","current","onComplete","status","onFail","onProgress","location","onNavigate","error","_timers","run","$page","$progress","find","$status","length","updateStatus","message","text","attr","html","removeClass","addClass","$","show","err","console","window","href","document","ready"],"mappings":"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"}