{"version":3,"file":"progress-element.js","sources":["django-data-wizard/packages/progress/src/progress.js","django-data-wizard/packages/progress-element/src/progress.js"],"sourcesContent":["export class Progress {\n    constructor(config) {\n        this.config = {\n            interval: 0.5,\n            ...config,\n        };\n        if (!this.config.url) {\n            throw new Error('No URL specified!');\n        }\n    }\n    start() {\n        this._throttle = 0;\n        this._throttleCount = 0;\n        this._lastProgress = null;\n        this._timer = setInterval(\n            () => this.update(),\n            this.config.interval * 1000\n        );\n    }\n    stop() {\n        if (this._timer) {\n            clearInterval(this._timer);\n        }\n        delete this._throttle;\n        delete this._throttleCount;\n        delete this._lastProgress;\n        delete this._timer;\n    }\n    async update() {\n        if (this._pending) {\n            return;\n        }\n        if (this._throttleCount < this._throttle) {\n            this._throttleCount += 1;\n            return;\n        } else {\n            this._throttleCount = 0;\n        }\n        let data;\n        try {\n            this._pending = true;\n            const controller = new AbortController(),\n                timeout = setTimeout(() => controller.abort(), 10000),\n                response = await fetch(this.config.url, {\n                    signal: controller.signal,\n                });\n\n            clearTimeout(timeout);\n            data = await response.json();\n            this._pending = false;\n        } catch (e) {\n            this._pending = false;\n            if (e.name === 'AbortError') {\n                this.onError(new Error('Timeout while requesting status'));\n            } else {\n                this.onError(e);\n            }\n            return;\n        }\n\n        let done = false;\n        if (!data.total) {\n            this.onIndeterminate(data);\n            this._throttle++;\n        } else {\n            // Set to progress level\n            if (this._lastProgress && data.current < this._lastProgress) {\n                // Assume out-of order response; no update\n                /* jshint noempty: false */\n            } else if (this._lastProgress == data.current) {\n                // No change since last check; check less often\n                this._throttle++;\n            } else {\n                // Change since last check; check more often\n                this._lastProgress = data.current;\n                if (this._throttle > 0) {\n                    this._throttle--;\n                }\n            }\n\n            if (data.current == data.total) {\n                this.onComplete(data);\n                done = true;\n            }\n        }\n\n        if (data.status == 'SUCCESS' && !done) {\n            this.onComplete(data);\n        } else if (data.status == 'FAILURE') {\n            this.onFail(data);\n        } else if (!done) {\n            this.onProgress(data);\n        }\n\n        if (data.location) {\n            this.onNavigate(data);\n        }\n    }\n\n    onIndeterminate(data) {\n        if (this.config.onIndeterminate) {\n            this.config.onIndeterminate(data);\n        }\n    }\n\n    onProgress(data) {\n        if (this.config.onProgress) {\n            this.config.onProgress(data);\n        }\n    }\n\n    onError(error) {\n        if (this.config.onError) {\n            this.config.onError(error);\n        }\n    }\n\n    onComplete(data) {\n        if (this.config.onComplete) {\n            this.config.onComplete(data);\n        }\n        this.stop();\n    }\n\n    onFail(data) {\n        this.stop();\n        if (this.config.onFail) {\n            this.config.onFail(data);\n        }\n    }\n\n    onNavigate(data) {\n        this.stop();\n        if (this.config.onNavigate) {\n            this.config.onNavigate(data);\n        }\n    }\n}\n","import $ from 'jquery';\nimport { Progress } from '@wq/progress';\n\n// Active progress instances\nvar _timers = {};\n\nexport function run($page) {\n    var $progress = $page.find('progress'),\n        $status;\n    if (!$progress.length) {\n        return;\n    }\n\n    if ($progress.data('wq-status')) {\n        $status = $page.find('#' + $progress.data('wq-status'));\n    }\n    // Look for a data-wq-url attribute to poll (and an optional data-interval attribute)\n    const url = $progress.data('wq-url'),\n        interval = $progress.data('wq-interval') || 0.5;\n\n    if (!url || _timers[url]) {\n        return;\n    }\n    function updateStatus(data) {\n        if ((data.error || data.message) && $status) {\n            $status.text(data.error || data.message);\n        }\n    }\n    _timers[url] = new Progress({\n        url,\n        interval,\n        onIndeterminate(data) {\n            // Set to \"intermediate\" state\n            $progress.attr('value', null);\n            $progress.attr('max', null);\n\n            // Fallback for old browsers\n            $progress.html('Loading...');\n            updateStatus(data);\n        },\n        onProgress(data) {\n            $progress.attr('value', data.current);\n            $progress.attr('max', data.total);\n\n            // Fallback for old browsers\n            $progress.html((data.current / data.total) * 100 + '%');\n            updateStatus(data);\n        },\n        onComplete(data) {\n            $progress.attr('value', data.total || 0);\n            $progress.attr('max', data.total || 0);\n            if ($status) {\n                $status.removeClass('error');\n            }\n            updateStatus(data);\n        },\n        onFail(data) {\n            $progress.attr('value', 0);\n            $progress.attr('max', data.total || 0);\n            if ($status) {\n                $status.addClass('error');\n            }\n            updateStatus(data);\n            $('.submit-row').show();\n        },\n        onError(err) {\n            if ($status) {\n                $status.text(err).addClass('error');\n            } else {\n                console.error(err);\n            }\n        },\n        onNavigate(data) {\n            window.location.href = data.location;\n        },\n    });\n    _timers[url].start();\n}\n\n$(document).ready(function () {\n    run($('body'));\n});\n"],"names":["Progress","constructor","config","_objectSpread","interval","url","Error","start","_throttle","_throttleCount","_lastProgress","_timer","setInterval","update","stop","clearInterval","_this","_asyncToGenerator","_pending","data","controller","AbortController","timeout","setTimeout","abort","response","fetch","signal","clearTimeout","json","e","name","onError","done","total","onIndeterminate","current","onComplete","status","onFail","onProgress","location","onNavigate","error","_timers","run","$page","$progress","find","$status","length","updateStatus","message","text","attr","html","removeClass","addClass","$","show","err","console","window","href","document","ready"],"mappings":"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"}